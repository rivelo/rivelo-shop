<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>Виписка по клієнту: {{client_name.name}}</title>


    <link rel="stylesheet" type="text/css" href="/media/table.css">
{#    <script type="text/javascript" src="/media/jquery-1.7.2.min.js"></script> #}
	<link rel="stylesheet" type="text/css" href="/media/jquery-ui-1.9.2.custom.css">	

	<script type="text/javascript" src="/media/jquery-1.8.3.js"></script>	
	<script type="text/javascript" src="/media/jquery-ui-1.9.2.custom.min.js"></script>
	<script src="/media/jquery.jeditable.mini.js" type="text/javascript" charset="utf-8"></script>

<style type="text/css">
#button > span.ui-icon-custom { 
    background-image: url(/media/images/Bicycle_ico.png)    
}
</style>

{% load poll_extras %}     
    
<script language="JavaScript">
$(document).ready(function() {
	$(document).tooltip();
	$("#dialog").hide();
	$("#dialog_r").hide();
	$("#dialog_msg").hide();
	
  	$( "#img_bike" ).click(function() {
  		$( "#dialog" ).dialog();
	});
	
	$( "#img_msg" ).click(function() {
  		$( "#dialog_msg" ).dialog({
  		resizable: false,
      	modal: true,
  		width: 380,
      	buttons: {
        "Додати": function() {
        	if (!$("#msg_text").length) { 
        	$( this ).append('<textarea type="text" id="msg_text" name="mytext[]" rows="10" cols="40"> </textarea>');
        	$( this ).append('<input type="button" class="ok_button" name="mytext[]" width="350" value="Відправити">');
        	}
        	//$( this ).dialog( "close" );
        },
        "Відмінити": function() {
        	$( this ).dialog( "close" );	
        },
        
        }  		
  		});
	});

	$(".ok_button").live('click', function(){
		console.log("Натиснуто ОК");
		$.ajax({
                type: "POST",
                url: "/clientmessage/add/",
                data: {client:  {{client_name.id}}, msg: $("#msg_text").attr("value") },
                dataType: "json",
                success:function(data){
                	$('#img_msg').css("opacity", 1);
//					document.getElementById("link_" + data.id).setAttribute("url", String(data.aData[0][0]));
					$( "#dialog_msg" ).close();                
                },
                error:function(){
                    alert("При отправке возникли проблемы");
                }
            });
	});
	
	//$('#img_repair').css("opacity", 1);
})


function res()
{
var p=0;
var All=document.forms['formSum'];
for(var i = 0; i < All.elements.length; ++i) {
	if(All.elements[i].checked){
	//p+=parseInt(All.elements[i].value);
	p=p+parseFloat(All.elements[i].value);
	}
	document.getElementById('for_pay').innerHTML = p.toFixed(2)+" грн.";
	document.getElementById('debet').innerHTML = parseFloat(document.getElementById('for_pay').innerHTML)+parseFloat(document.getElementById('workshop_pay').innerHTML);
}
}
    
function resWorkshop()
{
var p=0;
var All=document.forms['formWorkshopSum'];
for(var i = 0; i < All.elements.length; ++i) {
	if(All.elements[i].checked){
	p+=parseFloat(All.elements[i].value);
	}
	document.getElementById('workshop_pay').innerHTML = p.toFixed(2)+" грн.";
	document.getElementById('debet').innerHTML = parseFloat(document.getElementById('for_pay').innerHTML)+parseFloat(document.getElementById('workshop_pay').innerHTML);
}
}


$(function() {
    $( "#tabs" ).tabs({
      beforeLoad: function( event, ui ) {
        ui.jqXHR.error(function() {
          ui.panel.html(
            "Couldn't load this tab. We'll try to fix this as soon as possible. " +
            "If this wouldn't be a demo." );
        });
      }
    });

        $("#all_cred").click(function(){
            var Id = 2 
            $.ajax({
                type: "POST",
                url: "/client_history/",
                data: { clientId: Id },
                dataType: "json",
                success:function(msg){
                	$.each(msg,function(index,item){
                	    $('.in_cred').after('<tr><td>'+ item.fields.date +'</td><td>'+ item.fields.description +'</td><td>' + item.fields.price+'</td></tr>');
//                        tr = '<tr><td>'+ item.fields.date+'</td>';
//                        tr += '<td>' + item.fields.description+'</td>';
//                        tr += '<td>' + item.fields.price+'</td>';
//                        tr += '</tr>';
//                        $('#balance').children('tbody').append(tr);
                    });
//					$('#balance').append('<tr><td>00/00/0000</td><td>'+ msg[0].description +'</td><td></td></tr>');
//					$('.in_cred').after('<tr><td>00/00/0000</td><td>'+ msg[1].fields.description +'</td><td></td></tr>');
                },
                error:function(){
                    alert("При отправке возникли проблемы");
                }
            });      
		});

       
});
  
         
</script>

<body onLoad="res(); resWorkshop()">

<div style=" margin: 10px 0px 0px 0px;
    width: 800px;      
    float:left;  ">
    <h1>Виписка по клієнту:
    <span title="Телефон: {{client_name.phone|phone2Str}} <br> E-mail: {{client_name.email}}">
    	 <a href=/client/edit/{{client_name.id}}> {{client_name.name}} ({{client_name.forumname}}) </a>
    </span>
    </h1>
</div>

<div id="dialog_msg" title="Повідомлення">
{% for msg in messages %}
<p><b>Message: </b> <br> {{msg.msg}} </p>
{% endfor %}  
</div>	

<!-- repair bike  
<img style="display: none;" id="img_repair" src="http://thumb10.shutterstock.com/thumb_small/295516/103760093/stock-photo-bicycle-repair-sign-on-a-white-background-part-of-a-series-103760093.jpg" height="64px" >
-->

<img style="display: True; opacity: 0.2" id="img_repair" src="/media/images/bicycle-repair.jpg" height="56px" title="Майстерня">
{% if messages %}
<img style="display: True; opacity: 1" id="img_msg" src="/media/images/Message-ico.png" height="56px" title="Нові повідомлення">
{% else %}
<img style="display: True; opacity: 0.2" id="img_msg" src="/media/images/Message-ico.png" height="56px" title="Нові повідомлення">
{% endif %}
{% if b_bike %}
<img style="display: True;" id="img_bike" src="/media/images/green-bicycle_ico.png" height="50px" title="Придбані велосипеди">
{% endif %}

<div id="dialog_r" title="Заявки на ремонт:">
<table width='100%'>
  <script>
	$( "#img_repair" ).click(function() {
		window.location.href = "/workticket/add/client/"+ {{client_name.id}} +"/";	
//    	console.log("/workticket/add/client/"+ {{client_name.id}} +"/");
  	});
  </script>


{% for ticket in workshop  %}
{% if ticket.status__name = 'Прийнято' %}
  <tr bgcolor="#CCFF99" > 
  <script>
  $( "#img_repair" ).unbind(); 
  $( "#img_repair" ).click(function() {
  $( "#dialog_r" ).dialog({
      buttons: {
        "Додати": function() {
        	$( this ).dialog( "close" );
        	window.location.href = "/workticket/add/client/"+ {{client_name.id}} +"/";	
        },
        "Відмінити": function() {
        	$( this ).dialog( "close" );	
        },
        
        }
  });
  });

//  $('#img_repair').show();
  $('#img_repair').css("opacity", 1);

$('.edit_workstatus').editable('/workticket/edit/0/', { 
     loadurl : '/workstatus/view/',
     type   : 'select',
     submit : 'OK',
     submitdata : function() {
      	 	return {id_w : $(this).attr('id_workticket')};
     },
     callback : function(value, settings) {
         
       switch(value) {
		case 'Прийнято':
         $(this).closest("tr").attr('BGCOLOR', '#CCFF99');
         $('#img_repair').css("opacity", 1);
         break;
		case 'Ремонтується':
         $(this).closest("tr").attr('BGCOLOR', '#FFFF99');
		 break;
		case 'Виконано':
         $('#img_repair').css("opacity", 0.2);
		 break;
		case 'Виконано невидано':
         $('#img_repair').css("opacity", 0.2);
		 break;
		default :
         $(this).closest("tr").attr('BGCOLOR', '#FFFFFF');
       }
     }
 });

  </script>
  
{% else %}
  <tr bgcolor="#FFFFFF">
{% endif %}  
  <td>{{ticket.date}}</td><td>{{ticket.description}}</td><td class="edit_workstatus" id_workticket={{ticket.id}}>{{ticket.status__name}}</td>
  </tr>
{% endfor %}
</table>
</div>


<div id="dialog" title="Придбані велосипеди">
{% for bike in b_bike %}
<p><b>Велосипед {{bike.model__model__brand__name}} {{bike.model__model__model}} {{bike.model__size__name}}</b> S/N: [{{bike.model__serial_number}}] <br> Дата продажу: {{bike.date}} <br> Сервіс: {{bike.service|default:"Не пройдено"}}</p>
{% endfor %}  
</div>	
   
    

    <div style="clear:both;">
	<br>
	 <h2 style="color:red;"> Cума:  {{clients|floatformat:2}} грн.
	 </h2>	
	
	</div>

	
	
<table id="balance" >
	<tr><th>Дата</th>
	<th>Опис</th>
	<th>Сума (грн)</th>
	</tr>
	
	<tr BGCOLOR="#29AE48"  class="in_cred">
	<td>
	Оплати
	</td>
	<td><a href="/clientcredits/add/{{client_name.id}}">Створити нову проплату</a>  
	{% if perms.accounting.delete_clientcredits %}
	 /-----/ <a href="/clientcredits/{{client_name.id}}/delete/all">(Видалити всі проплати)</a> 
	 /-----/ <a id="all_cred" href="javascript:">(Показати всі проплати)</a>
	{% endif %}	
	 
	</td>
	<td>
	</td>
	</tr>
	
	
	{% for credit in credit_list %}
	<tr>
	<td>
		<abbr title="{{credit.date|time:"H:i"}} - [{{credit.user.username}}]">
	{{credit.date|date}}
	</abbr>
	</td>
	<td>
	{{credit.description}} 
	{% if perms.accounting.delete_clientcredits %}
	<a href="/clientcredits/edit/{{ credit.id }}">edit</a>	 
	<a href="/clientcredits/delete/{{ credit.id }}" onclick="return confirm('Видалити запис?')">delete</a>
	{% endif %}
	</td>
	<td>
	{{credit.price}}
	</td>
	{% endfor %}
	</tr>

	<tr BGCOLOR="#F11111">
	<td>
	Борги
	</td>
	<td><a href=/clientdebts/add/{{client_name.id}}> Додати борг </a>
	{% if perms.accounting.delete_clientcredits %}
	 /-----/ <a href="/clientdebts/{{client_name.id}}/delete/all">(Видалити всі борги)</a> 
	{% endif %}	
	</td>
	<td id="debet">
	</td>
	</tr>

	{% for debt in debt_list %}
	<tr>
	<td>
	<abbr title="{{debt.date|time:"H:i"}} - [{{debt.user.username}}]">
	{{debt.date|date}}
	</abbr>
	</td>
	<td>
	{{debt.description}}
	{% if perms.accounting.delete_preorder %}
    <a href="/clientdebts/edit/{{ debt.id }}" >edit</a>	
    <a href="/clientdebts/delete/{{ debt.id }}" onclick="return confirm('Видалити запис?')">delete</a>	
	{% endif %}
	</td>
	<td>
	{{debt.price}}
	</td>
	{% endfor %}
	</tr>
	
	</table>

<div id="tabs">
  <ul>
    <li><a href="#tabs-1">Товари</a></li>
    <li><a href="/client/{{client_name.id}}/invoice/lookup/">Проданий товар</a></li>
    <li><a href="//content3-slow.php">Виконані роботи</a></li>
    <li><a href="#tabs-2">Майстерня</a></li>
  </ul>
  <div id="tabs-1">
{# Проданий Товар #}	
<form action="/payform/" method="post" name="formSum">
	<br>
	<table id="product">
	<tr bgcolor="grey">
	<th>Дата</th>
	<th>Товар</th>
	<th>Кількість</th>
	<th>Прайс</th>
	<th>Сума</th>
	<th>Оплата</th>
	<th>Валюта</th>
	<th>Оплата</th>
	</tr>
	
	{% for inv in invoice %}
	<tr>
	<td>
	{{inv.date}}
	</td>
	<td>
	{{inv.catalog}}
	</td>
	<td>
	{{inv.count}}
	</td>
	<td>
	{{inv.price}}
	</td>
	<td>
	{{inv.sum}}
	</td>
	
{% ifequal inv.sum inv.pay %}
<td>
	{{inv.pay}}
	</td>	
	<td>
	{{inv.currency}}
	</td>
	<td align="center">
	<input type="checkbox" id="model{{forloop.counter}}" value="{{inv.sum}}" onclick="res()" name="checkbox_{{ inv.id }}"/>
	</td>
{% else %}
	<td BGCOLOR="#FF6600">
	{{inv.pay}}
	</td>	
	<td>
	{{inv.currency}}
	</td>
	<td align="center">
	<input type="checkbox" id="model{{forloop.counter}}" value="{{inv.sum}}" onclick="res()" checked name="checkbox_{{ inv.id }}"/>
	</td>
{% endifequal %}
	</tr>
	{% endfor %}
	
	<tr>
	<th></th>
	<th></th>
	<th></th>
	<th>Загальна сума</th>
	<th>{{client_invoice_sum}} грн.</th>
	<th><p><input type="submit" value="Оплата" name="pay"></p>
	<input type="submit" value="E-mail" name="send_check"></th>
	<th BGCOLOR="#D5FFB4">До оплати</th>
	<th id="for_pay" BGCOLOR="#D5FFB4">0</th>
	</tr>
	</table>
</form>	

  </div>

<div id="tabs-2">
{# Роботи майстерні #}
<form action="/payform/workshop/" method="post" name="formWorkshopSum" >
<br>
	<table border=1 width="100%" style="font-size : 12px; font-family : Arial;">
	<tr bgcolor="grey">
	<th>Дата</th>
	<th>Робота</th>
	<th>Прайс</th>
	<th>Опис</th>
	<th>Оплата</th>
	</tr>
	
	{% for inv in workshop %}
	<tr>
	<td>
	{{inv.date}}
	</td>
	<td>
	{{inv.work_type}}
	</td>
{% if inv.pay %}	
	<td>
	{{inv.price}}
	</td>
	<td>
	{{inv.description}}
	</td>	
	<td align="center">
	<input type="checkbox" id="model_workshop{{forloop.counter}}" value="{{inv.price}}" onclick="resWorkshop()" name="checkbox_{{ inv.id }}"/>
	</td>	
{% else %}
	<td BGCOLOR="#FF6600">
	{{inv.price}}
	</td>
	<td>
	{{inv.description}}
	</td>	
	<td align="center">
	<input type="checkbox" id="model_workshop{{forloop.counter}}" value="{{inv.price}}" onclick="resWorkshop()" checked name="checkbox_{{ inv.id }}"/>
	</td>
{% endif %}
	</tr>
	{% endfor %}
	
	<tr>
	<th></th>
	<th>Загальна сума</th>
	<th>{{client_workshop_sum}} грн.</th>
	<th BGCOLOR="#D5FFB4">
	<p><input type="submit" value="Оплата" name="pay" onClick="return confirm('Провести операцію?')"></p>
	<input type="submit" value="E-mail" name="send_check">	
	</th>
	<th><p>До оплати:</p><p id="workshop_pay" BGCOLOR="#D5FFB4">0<p></th>
	</tr>
	</table>
</form>
	</div>
</div>


<a href=/workticket/add/client/{{client_name.id}}/> 
Створити заявку на ремонт
</a>
<br>
<a href=/workshop/add/client/{{client_name.id}}/> 
Додати роботу
</a>
<br>	
<br>
<a href=/client/search/> Пошук клієнта </a>
 



